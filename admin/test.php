<?php$task_from      = $_GET['task_from'];$task_status    = $_GET['task_status'];$task_from_star = $_GET['task_from_star'];$para = array('task_from','task_status','task_from_star');foreach ($para AS $paras){    if(isset($_REQUEST[$paras]) && !empty($_REQUEST[$paras])){        $parameters[$paras] = $_REQUEST[$paras];        if($parameters['task_status'] == 3){            $parameters['task_status'] = 0;        }        if($parameters['task_from_star'] == 'donot'){            $parameters['task_from_star'] = 0;        }    }}$parameters_list = '';if($type == 'send'){    $parameters['task_from'] = $user_id;}if($parameters){    foreach ($parameters as $key => $value) {        if(!$type){            $colums[]  = _TABLE_TASKS.'.'.$key .' = "'. checkInsert($value) .'"';            $parameters_list   = ' '.implode(' AND ', $colums).' ';        }else{            $colums[]  = '`'.$key .'` = "'. checkInsert($value) .'"';            $parameters_list   = ' WHERE '.implode(' AND ', $colums).' ';        }    }}// Tạo Url Parameter độngforeach ($parameters as $key => $value) {    $para_url[] = $key .'='. $value;}$para_list                      = implode('&', $para_url);// Tạo Url Parameter động$config_pagenavi['page_row']    = _CONFIG_PAGINATION;$config_pagenavi['url']         = _URL_ADMIN.'/tasks.php'.( $type ? '?type='.$type : '').( $parameters ? ($type ? '&'.$para_list : '?'.$para_list) : '' ).( (!$type && !$parameters) ? '?' : '&' );$page_start                     = ($page-1) * $config_pagenavi['page_row'];$css_plus       = array('app-assets/css/chosen.css');$js_plus        = array(    'app-assets/js/chosen.jquery.js',    'app-assets/js/prism.js',    'app-assets/js/init.js');$admin_title = $lang['tasks_manager'];require_once 'header.php';?>    <div class="row">        <div class="col-md-3">            <div class="card">                <div class="card-header"><h4 class="card-title"> Quản lý công việc </h4> </div>                <div class="card-content collapse show">                    <ul class="list-group">                        <li class="list-group-item">                                <span class="float-left">                                    <i class="la la-star-o mr-1"></i>                                </span>                            <a href="<?php echo _URL_ADMIN.'/tasks.php';?>" <?php echo !$type ? 'style="color: red; font-weight: bold"' : '';?>> Việc của bạn</a>                        </li>                        <li class="list-group-item">                                <span class="float-left">                                    <i class="la la-envelope-o mr-1"></i>                                </span>                            <a href="<?php echo _URL_ADMIN.'/tasks.php?type=send';?>" <?php echo $type == 'send' ? 'style="color: red; font-weight: bold"' : '';?>> Việc Đã Gửi</a>                        </li>                        <li class="list-group-item">                                <span class="float-left">                                    <i class="la la-check-circle-o mr-1"></i>                                </span>                            <a href="<?php echo _URL_ADMIN.'/tasks.php?type=report';?>" <?php echo $type == 'report' ? 'style="color: red; font-weight: bold"' : '';?>> Báo cáo của bạn</a>                        </li>                    </ul>                </div>            </div>        </div>        <div class="col-md-9">            <form action="" method="get">                <div class="row">                    <?php                    switch ($type){                        case 'send':                            $query                          = 'SELECT * FROM `'. _TABLE_TASKS .'` '.$parameters_list.' ORDER BY `id` DESC LIMIT '.$page_start.','.$config_pagenavi['page_row'];                            $config_pagenavi['page_num']    = ceil(mysqli_num_rows(mysqli_query($db_connect, 'SELECT `id` FROM `'. _TABLE_TASKS .'` '.$parameters_list))/$config_pagenavi['page_row']);                            $data_send_star                 = array('task_from' => $user_id, 'task_status' => 2, 'task_from_star' => 0);                            $number_send_star               = checkGlobal(_TABLE_TASKS, $data_send_star);                            $query_deadline                 = 'SELECT * FROM `'. _TABLE_TASKS .'` WHERE `task_from` = "'. $user_id .'" AND `task_end` < "'. date('Y-m-d', time()) .'" AND `task_status` != 2 ORDER BY `id` DESC LIMIT '. $page_start .','.$config_pagenavi['page_row'];                            $number_deadline                = mysqli_num_rows(mysqli_query($db_connect, $query_deadline));                            // Gán status = 4 thì query các việc bị trễ deadline                            if($task_status == 4){                                $query = $query_deadline;                            }                            ?>                            <div class="col text-left">                                <select name="task_status" class="form-control round">                                    <option value="" <?php echo empty($task_status) ? 'selected="selected"' : '';?>>Chọn trạng thái</option>                                    <option value="2" <?php echo $task_status == 2 ? 'selected="selected"' : '';?>>Đã hoàn thành</option>                                    <option value="1" <?php echo $task_status == 1 ? 'selected="selected"' : '';?>>Đã nhận việc</option>                                    <option value="3" <?php echo $task_status == 3 ? 'selected="selected"' : '';?>>Chưa nhận việc</option>                                </select>                                <input type="hidden" name="type" value="send">                            </div>                            <?php                            if($number_send_star > 0){                                echo '<div class="col text-left"><a class="btn btn-outline-cyan round" href="tasks.php?type=send&task_status=2&task_from_star=donot">'. $number_send_star .' việc chưa đánh giá</a> </div>';                            }                            if($number_deadline > 0){                                echo '<div class="col text-left"><a class="btn btn-outline-cyan round" href="tasks.php?type=send&task_status=4">'. $number_deadline .' việc trễ Deadline</a> </div>';                            }                            echo '<div class="col text-right"><input type="submit" value="Lọc kết quả" class="btn btn-outline-cyan round"></div>';                            break;                        case 'report':                            $query = 'SELECT * FROM `'. _TABLE_TASKS .'` WHERE `task_type` = "report" AND `task_from` = "'. $user_id .'"  ORDER BY `id` DESC LIMIT '.$page_start.','.$config_pagenavi['page_row'];                            $config_pagenavi['page_num']    = ceil(mysqli_num_rows(mysqli_query($db_connect, 'SELECT `id` FROM `'. _TABLE_TASKS .'` WHERE `task_type` = "report" AND `task_from` = "'. $user_id .'"'))/$config_pagenavi['page_row']);                            echo '<input type="hidden" name="type" value="report">';                            break;                        default:                            $query = 'SELECT dong_group.group_id, dong_group.group_value, dong_task.*                                       FROM dong_group                                      INNER JOIN dong_task                                       ON dong_group.group_id = dong_task.id                                       WHERE dong_group.group_type = "tasks"                                       AND dong_group.group_value = '. $user_id .' '. ($parameters_list ? ' AND '.$parameters_list : '') .'                                       ORDER BY dong_task.id DESC LIMIT '.$page_start.','.$config_pagenavi['page_row'];                            $query_1 = 'SELECT dong_group.group_id, dong_group.group_value, dong_task.*                                       FROM dong_group                                      INNER JOIN dong_task                                       ON dong_group.group_id = dong_task.id                                       WHERE dong_group.group_type = "tasks"                                       AND dong_group.group_value = '. $user_id .' '. ($parameters_list ? ' AND '.$parameters_list : '') .'                                       ORDER BY dong_task.id DESC';                            $config_pagenavi['page_num']    = ceil(mysqli_num_rows(mysqli_query($db_connect, $query_1))/$config_pagenavi['page_row']);                            ?>                            <div class="col text-left">                                <select name="task_from" data-placeholder="Chọn người gửi" class="chosen-select-width form-control">                                    <option value=""></option>                                    <?php                                    $users_list = getGlobalAll(_TABLE_USERS, '', array('order_by_row' => 'users_name', 'order_by_value' => 'ASC'));                                    foreach ($users_list AS $users){                                        echo '<option value="'. $users['users_id'] .'" '. (($task_from == $users['users_id']) ? 'selected' : '') .'>'. $users['users_name'] .'</option>';                                    }                                    ?>                                </select>                            </div>                            <div class="col text-left">                                <select name="task_status" class="form-control round">                                    <option value="" <?php echo empty($task_status) ? 'selected="selected"' : '';?>>Chọn trạng thái</option>                                    <option value="2" <?php echo $task_status == 2 ? 'selected="selected"' : '';?>>Đã hoàn thành</option>                                    <option value="1" <?php echo $task_status == 1 ? 'selected="selected"' : '';?>>Đã nhận việc</option>                                    <option value="3" <?php echo $task_status == 3 ? 'selected="selected"' : '';?>>Chưa nhận việc</option>                                </select>                            </div>                            <div class="col text-right"><input type="submit" value="Lọc kết quả" class="btn btn-outline-cyan round"></div>                            <?php                            break;                    }                    ?>                </div>                <br />            </form>            <div class="card">                <div class="card-body">                    <?php                    echo '<div class="table-responsive">';                    echo '<table class="table">';                    if($type == 'send'){                        echo '<thead>';                        echo '<th>Tiêu đề</th>';                        echo '<th>Người nhận</th>';                        echo '<th>Trạng thái</th>';                        echo '<th>Thời gian</th>';                        echo '</thead>';                    }else if($type == 'report'){                        echo '<thead>';                        echo '<th width="80%">Tiêu đề</th>';                        echo '<th width="20%">Thời gian</th>';                        echo '</thead>';                    }else{                        echo '<thead>';                        echo '<th>Người gửi</th>';                        echo '<th>Tiêu đề</th>';                        echo '<th>Trạng thái</th>';                        echo '<th>Thời gian</th>';                        echo '</thead>';                    }                    echo '<tbody>';                    $data   = getGlobalAll(_TABLE_TASKS, array(), array('query' => $query));                    if(!$data){                        echo '<tr><td colspan="4" width="100%" class="text-center">Chưa có công việc nào.</td></tr>';                    }                    foreach ($data AS $datas){                        switch ($datas['task_status']){                            case 0:                                $color_text = 'text-danger';                                break;                            case 1:                                $color_text = 'teal';                                break;                            case 2:                                $color_text = 'purple';                                break;                        }                        if($type == 'send'){                            $users_receive_data = array('group_id' => $datas['id'], 'group_type' => 'tasks');                            $users_receives = array();                            // Get danh sách người nhận                            if(checkGlobal(_TABLE_GROUP, $users_receive_data) <= 3){                                foreach (getGlobalAll(_TABLE_GROUP, $users_receive_data) AS $users_list){                                    $users_receives[] = '<a href="'. _URL_ADMIN .'/users.php?act=detail&id='. $users_list['group_value'] .'">'. getGlobalAll(_TABLE_USERS, array('users_id' => $users_list['group_value']), array('onecolum' => 'users_name')) .'</a>';                                }                                $users_receive = implode($users_receives, ', ');                            }else{                                foreach (getGlobalAll(_TABLE_GROUP, $users_receive_data, array('limit_number' => 3, 'order_by_row' => 'id', 'order_by_value' => 'DESC')) AS $users_list){                                    $users_receives[] = '<a href="'. _URL_ADMIN .'/users.php?act=detail&id='. $users_list['group_value'] .'">'. getGlobalAll(_TABLE_USERS, array('users_id' => $users_list['group_value']), array('onecolum' => 'users_name')) .'</a>';                                }                                $users_receive = implode($users_receives, ', ').' và '.(checkGlobal(_TABLE_GROUP, $users_receive_data) - 3).' người nữa';                            }                            echo '<tr>';                            echo '<td width="50%"><a href="'. _URL_ADMIN .'/tasks.php?act=detail&id='. $datas['id'] .'">'. ($datas['task_status'] == 0 ? '<strong class="'. $color_text .'">'. $datas['task_name'] .'</strong>' : '<font class="'. $color_text .'">'.$datas['task_name']) .'</a></td>';                            echo '<td width="20%">'. $users_receive .'</td>';                            echo '<td width="20%">'. $lang['tasks_status_'.$datas['task_status']]  .'</td>';                            echo '<td width="10%">'. getViewTime($datas['task_time']) .'</td>';                            echo '</tr>';                        }else if($type == 'report'){                            echo '<tr>';                            echo '<td width="80%"><a href="'. _URL_ADMIN .'/tasks.php?act=detail&id='. $datas['id'] .'">'. ($datas['task_status'] == 0 ? '<strong class="'. $color_text .'">'. $datas['task_name'] .'</strong>' : '<font class="'. $color_text .'">'.$datas['task_name']) .'</a></a></td>';                            echo '<td width="20%">'. getViewTime($datas['task_time']) .'</td>';                            echo '</tr>';                        }                        else{                            echo '<tr>';                            echo '<td width="20%"><a href="'. _URL_ADMIN .'/users.php?act=detail&id='. $datas['task_from'] .'">'. getGlobalAll(_TABLE_USERS, array('users_id' => $datas['task_from']), array('onecolum' => 'users_name')) .'</a></td>';                            echo '<td width="50%"><a href="'. _URL_ADMIN .'/tasks.php?act=detail&id='. $datas['id'] .'">'. ($datas['task_status'] == 0 ? '<strong class="'. $color_text .'">'. $datas['task_name'] .'</strong>' : '<font class="'. $color_text .'">'.$datas['task_name']) .'</a></a></td>';                            echo '<td width="20%">'. $lang['tasks_status_'.$datas['task_status']]  .'</td>';                            echo '<td width="10%">'. getViewTime($datas['task_time']) .'</td>';                            echo '</tr>';                        }                    }                    echo '</tbody>';                    echo '</table>';                    echo '</div>';                    echo '<nav aria-label="Page navigation">'.pagination($config_pagenavi).'</nav>';                    ?>                </div>            </div>        </div>    </div><?php